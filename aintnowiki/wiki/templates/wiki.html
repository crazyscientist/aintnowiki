{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{% block title %}{{ object.title|default:"Ain't no title" }}{% endblock %}</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
              crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
                crossorigin="anonymous"></script>
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
        <link href="{% static 'css/anw.css' %}" rel="stylesheet">

        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
        <script src="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.js"></script>
        <script src="https://uicdn.toast.com/editor-plugin-uml/latest/toastui-editor-plugin-uml.min.js"></script>

        {% verbatim %}
        <script type="text/x-template" id="tag-template">
            <span class="badge badge-pill bg-secondary me-2" v-bind:title="tag.description"
                  v-bind:class="tagClass" v-bind:style="tagStyle">
                {{ tag.name }}
            </span>
        </script>
        <script type="text/x-template" id="tagnav-template">
            <div>
                <div class="btn-group float-start mt-2 me-2" role="group"
                     v-bind:aria-label="item.tag.name">
                    <input type="checkbox" class="btn-check" v-bind:id="item.tag.slug"
                           autocomplete="off">
                    <label class="btn btn-secondary btn-sm" v-bind:for="item.tag.slug"
                           v-bind:title="item.tag.description" v-bind:class="tagClass"
                           v-bind:style="tagStyle" v-on:click="checkTag($event, item.tag.id)">
                        {{ item.tag.name}}
                    </label>
                    <a class="btn btn-secondary btn-sm tag-expand" data-bs-toggle="collapse"
                       v-bind:href="childListRef" role="button" aria-expanded="false"
                       v-bind:aria-controls="childListId" v-bind:class="tagClass"
                       v-bind:style="tagStyle" v-if="hasChildren" title="expand">
                        <i class="bi bi-caret-down"></i>
                    </a>
                </div>
                <div class="collapse clearfix ms-3 mt-2" v-bind:id="childListId" v-if="hasChildren"
                     style="clear: left;">
                    <tag-list v-for="child in item.children" :key="child.id" :item="child"
                              v-on="$listeners"></tag-list>
                </div>
            </div>
        </script>
        <script type="text/x-template" id="viewer-template">
            <div class="container pt-3" id="wiki-viewer" v-bind:class="[hidden ? 'visually-hidden': '']">
                <div class="float-end">
                    <a v-bind:href="item.url" class="btn btn-secondary" title="Direct link">
                        <i class="bi bi-link-45deg"></i>
                    </a>
                </div>
                <div ref="ToastUiViewer"></div>
                <div class="row">
                    <div class="col-sm-8 mb-3">
                        <h6><i class="bi bi-tags-fill"></i> Tags</h6>
                            <tag-item v-for="tag in item.tags" v-bind:tag="tag" v-bind:key="tag.id">
                            </tag-item>
                    </div>
                    <div class="col-sm-4 mb-3">
                        <h6><i class="bi bi-calendar"></i> Timestamps</h6>
                        <i class="bi bi-file-plus" title="Created"></i> {{ objectCreatedDate }}</br>
                        <i class="bi bi-file-diff" title="Changed"></i> {{ objectChangedDate }}
                    </div>
                </div>
            </div>
        </script>
        <script type="text/x-template" id="list-template">
            <div class="container" id="wiki-list" ref="WikiList"
                 v-bind:class="[visible ? '': 'visually-hidden']">
                <div class="card mt-3" v-for="item in items" :key="item.id">
                    <div class="card-header">
                        <a v-bind:href="item.url" v-on:click="loadPage" v-bind:data-url="item.apiurl">
                            {{ item.title }}
                        </a>
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ item.summary }}</p>
                    </div>
                    <div class="card-footer">
                        <div class="text-muted small float-end">
                            <i class="bi bi-clock-fill"></i>
                            {{ item.changed }}
                        </div>
                        <tag-item v-for="tag in item.tags" v-bind:tag="tag" v-bind:key="tag.id">
                        </tag-item>
                    </div>
                </div>
                <div class="d-flex justify-content-center mt-3 wiki-list-spinner"  ref="Spinner"
                     v-bind:class="[showSpinner ? '': 'visually-hidden']">
                    <div class="spinner-border text-secondary shadow" role="status"
                         style="height: 2.5rem; width: 2.5rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </script>
        {% endverbatim %}

        {{ navigation|json_script:"navigation-data" }}
        {{ json_object|json_script:"object-data" }}

        <script>
            function parse_if_possible(encoded_text) {
                try {
                    return JSON.parse(encoded_text) || {}
                } catch (e) {
                    return null
                }
            }
            const object_data = parse_if_possible(document.getElementById('object-data').textContent);
            const umlOptions = {rendererURL: "{{ PLANTUML_RENDERER_URL }}"};
            console.log("UML options", umlOptions);

            const { Editor } = toastui;
            const { uml } = Editor.plugin;
            const vue_data = {
                navtags: parse_if_possible(document.getElementById('navigation-data').textContent),
                selectedTags: [],
                dataObject: object_data,
                listUrl: "{% url 'api_wiki:pages' %}",
                viewerOptions: {
                    viewer: true,
                    usageStatistics: false,
                    plugins: [[uml, umlOptions]],
                    initialValue: object_data.content || ""
                },
                hideViewer: (object_data === "" || object_data === null
                             || Object.keys(object_data).length === 0),
                searchstring: ""
            };

            Vue.component('tag-item', {
                template: "#tag-template",
                props: {tag: Object},
                computed: {
                    tagClass: function () {
                        if (this.tag.attributes !== null && this.tag.attributes !== undefined) {
                            return this.tag.attributes.class
                        }
                    },
                    tagStyle: function () {
                        if (this.tag.attributes !== null && this.tag.attributes !== undefined) {
                            return this.tag.attributes.style
                        }
                    }
                }
            });

            Vue.component('tag-list', {
                template: "#tagnav-template",
                props: {item: Object},
                computed: {
                    tagClass: function() {
                        if (this.item.tag.attributes !== null && this.item.tag.attributes !== undefined) {
                            return this.item.tag.attributes.class
                        }
                    },
                    tagStyle: function() {
                        if (this.item.tag.attributes !== null && this.item.tag.attributes !== undefined) {
                            return this.item.tag.attributes.style
                        }
                    },
                    childListId: function() {
                        if (this.item.children.length > 0) {
                            return "children_" + this.item.tag.slug
                        }
                    },
                    childListRef: function() {
                        return "#" + this.childListId
                    },
                    hasChildren: function() {
                        if (this.item.children !== undefined && this.item.children !== null) {
                            return (this.item.children.length > 0)
                        }
                        return false
                    }
                },
                methods: {
                    checkTag: function (event, tag_id) {
                        let was_checked = event.target.control.checked;
                        console.log("A tag was checked", was_checked, tag_id);
                        if (!was_checked) {
                            this.$emit("tagselected", tag_id);
                        } else {
                            this.$emit("tagunselected", tag_id);
                        }
                    }
                }
            });

            Vue.component('toastui-viewer', {
                template: "#viewer-template",
                props: {options: Object, item: Object, hidden: Boolean},
                data: function () {
                    return {isLoaded: false}
                },
                computed: {
                    objectCreatedDate: function() {
                        let d = new Date(this.item.created);
                        return d.toDateString();
                    },
                    objectChangedDate: function() {
                        let d = new Date(this.item.changed);
                        return d.toDateString();
                    }
                },
                methods: {
                    initViewer: function () {
                        if (this.viewer !== null && this.viewer !== undefined
                                && this.$refs.ToastUiViewer !== undefined) {
                            return null
                        }

                        this.options.el = this.$refs.ToastUiViewer;
                        this.options.viewer = true;
                        this.options.usageStatistics = false;
                        this.viewer = new toastui.Editor(this.options);
                        this.isLoaded = true;

                        if (this.item !== undefined && this.item !== null) {
                            this.updateViewer(this.item.content);
                        }
                    },
                    updateViewer: function (new_content) {
                        this.viewer.setMarkdown(new_content);
                        this.isLoaded = true;
                    }
                },
                mounted: function () {
                    this.$nextTick(function() {
                        this.initViewer();
                    });
                },
                updated: function () {
                    this.initViewer();
                },
                watch: {
                    "item.content": function (val) {
                        this.initViewer();
                        this.updateViewer(val);
                    }
                }
            });

            Vue.component('wiki-list', {
                template: "#list-template",
                props: {url: String, item: Object, visible: Boolean, searchstring: String},
                data: function () {
                    return {
                        showSpinner: true,
                        nextUrl: null,
                        items: [],
                        filterTags: [],
                        observerOptions: {
                            root: null,
                            threshold: 0
                        },
                        loadedOnInit: false,
                    };
                },
                computed: {
                    baseUrl: function () {
                        let url = new URL(window.location.href);
                        return url.origin
                    }
                },
                mounted: function () {
                    if (this.$refs.WikiList !== undefined) {
                        this.observer = new IntersectionObserver(this.intersectionCallback,
                                                                 this.observerOptions);
                        if (this.visible) {
                            this.loadedOnInit = true;
                            this.loadList();
                        }
                    }
                },
                methods: {
                    intersectionCallback: function (entries, observer) {
                        let spinner = this.$el.lastChild;
                        var vm = this;
                        entries.forEach(function (entry) {
                            if (entry.isIntersecting && entry.target === spinner && vm.showSpinner) {
                                vm.loadPartialList();
                            }
                        });
                    },
                    loadPartialList: function (url) {
                        this.showSpinner = true;
                        var vm = this;
                        let nexturl = url || this.nextUrl;

                        if (nexturl === null) {
                            console.warn("No URL specified for fetching.", url, this.nextUrl);
                            return null;
                        }

                        console.debug("Fetching part of list", nexturl)
                        fetch(nexturl.href)
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (data) {
                                vm.observer.unobserve(vm.$refs.Spinner);
                                vm.items = vm.items.concat(data.results || []);
                                if (data["next"] !== null) {
                                    vm.nextUrl = new URL(data["next"]);
                                    vm.showSpinner = true;
                                    vm.observer.observe(vm.$refs.Spinner);
                                    console.debug("Next URL", vm.nextUrl);
                                } else {
                                    vm.nextUrl = null;
                                    vm.showSpinner = false;
                                    console.debug("End. Unsetting next URL", vm.nextUrl)
                                }
                                vm.$emit("listupdated");
                            })
                            .catch(function (error) {
                                vm.hasError = true;
                                vm.showSpinner = false;
                            });
                    },
                    loadList: function (tag_ids) {
                        var url = new URL(this.url, this.baseUrl);
                        this.nextUrl = null;
                        this.items = [];
                        if (this.searchstring !== undefined && this.searchstring !== null
                                && this.searchstring !== "") {
                            url.searchParams.append('q', this.searchstring);
                        }
                        if (tag_ids !== undefined && tag_ids.length > 0) {
                            tag_ids.forEach(function(tag_id) {
                                url.searchParams.append('tag', tag_id);
                            });
                        }
                        console.debug("Fetching list", url);
                        this.loadPartialList(url);
                    },
                    loadPage: function (event) {
                        var vm = this;

                        fetch(event.target.dataset.url)
                            .then(function (response){
                                return response.json();
                            })
                            .then(function (data){
                                vm.$emit("pageloaded", data);
                            });
                        event.preventDefault();
                    }
                },
                watch: {
                    visible: function (val) {
                        if (val && !this.loadedOnInit) {
                            this.loadedOnInit = true;
                            this.loadList();
                        }
                    }
                }
            })
        </script>
        <!--script src="{% static 'js/anw.js' %}"></script-->
    </head>
    <body>
        <div class="container-fluid p-0" id="app">
            <nav class="navbar navbar-dark navbar-expand bg-primary sticky-top">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">{{ BRAND_HTML|safe }}</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarCollapsed" aria-controls="navbarCollapsed"
                            aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarCollapsed">
                        <div class="d-flex justify-content-between" style="width: 100%;">
                            <ul class="navbar-nav me-auto">
                                <li class="nav-item m-1">
                                    <a class="nav-link border rounded shadow" data-bs-toggle="offcanvas"
                                       href="#tag-nav" role="button" aria-controls="tag-nav"
                                       title="Expand tag menu">
                                        <i class="bi bi-tags-fill"></i>
                                    </a>
                                </li>
                                <li class="nav-item m-1">
                                    <a class="nav-link border rounded shadow" role="button"
                                       title="Toggle list/page view" v-show="showToggleButton()"
                                       v-on:click="toggleViews()">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </a>
                                </li>
                            </ul>
                            <div id="searchbox" class="input-group">
                                <input type="text" class="form-control" placeholder="Search"
                                       aria-label="Search" aria-describedby="search-label"
                                       v-model="searchstring" minlength="4">
                                 <span class="input-group-text" id="search-label">
                                     <i class="bi bi-search"></i>
                                 </span>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="container-fluid mb-3">
                    <noscript>
                        <div class="alert alert-danger" role="alert">
                            You have disabled JavaScript! This is not supported.
                        </div>
                </noscript>

                <div class="offcanvas offcanvas-start clearfix" id="tag-nav"  data-bs-scroll="true"
                     data-bs-backdrop="true" tabindex="-1"
                     aria-labelledby="offcanvasScrollingLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title" id="offcanvasScrollingLabel">
                            <i class="bi bi-funnel-fill"></i> Tag Filters
                        </h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                                aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <div>
                            <h6>Selected:</h6>
                            <tag-item v-for="tag in selectedTags" :key="'selected_' + tag.slug" :tag="tag">
                            </tag-item>
                        </div>
                        <hr>
                        <tag-list v-for="tag in navtags" :item="tag" :key="tag.id"
                                  v-on:tagselected="addSelectedTag" v-on:tagunselected="delSelectedTag">
                        </tag-list>
                    </div>
                </div>

                <toastui-viewer :options="viewerOptions" :item="dataObject" :hidden="hideViewer"
                                v-on:listupdated="switchToList" ref="Viewer">
                </toastui-viewer>
                <wiki-list :url="listUrl" :item="dataObject" :visible="hideViewer"
                           :searchstring="searchstring"
                           v-on:pageloaded="switchToPage" v-on:listupdated="switchToList"
                           ref="TagList">
                </wiki-list>
            </div>
        </div>
        <script>
            var vueapp = new Vue({
                el: "#app",
                data: vue_data,
                computed: {
                    allTags: function () {
                        let tags = {};
                        function add_tag (item) {
                            tags[item.tag.id] = item.tag;
                            if (item.children !== undefined && item.children !== null) {
                                item.children.forEach(add_tag);
                            }
                        }

                        this.navtags.forEach(add_tag);
                        return tags;
                    }
                },
                created: function () {
                    this.hideViewer = (object_data === "" || object_data === null
                                       || Object.keys(object_data).length === 0);
                    this.debouncedSearchHandler = _.debounce(this.updateList, 300);
                },
                methods: {
                    switchToPage: function (pageData) {
                        this.dataObject = pageData;
                        this.hideViewer = false;
                    },
                    switchToList: function () {
                        this.hideViewer = true;
                    },
                    toggleViews: function () {
                        this.hideViewer = !this.hideViewer;
                    },
                    addSelectedTag: function (tag_id) {
                        let tag = this.allTags[tag_id];
                        this.selectedTags.push(tag);
                        this.updateList();
                    },
                    delSelectedTag: function (tag_id) {
                        this.selectedTags = this.selectedTags.filter(tag => tag.id !== tag_id);
                        this.updateList();
                    },
                    updateList: function () {
                        let tag_ids = [];
                        this.selectedTags.forEach(function (tag) {
                            tag_ids.push(tag.id);
                        });
                        this.$refs.TagList.loadList(tag_ids);
                    },
                    showToggleButton: function () {
                        if (!this.hideViewer) {
                            return true;
                        }
                        if (this.hideViewer && this.$refs.Viewer !== undefined
                                && this.$refs.Viewer.isLoaded) {
                            return true;
                        }
                        return false;
                    }
                },
                watch: {
                    searchstring: function (val) {
                        this.debouncedSearchHandler();
                    }
                }
            });
        </script>
    </body>
</html>